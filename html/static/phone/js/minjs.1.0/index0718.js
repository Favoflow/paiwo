$(function(){$(".column").tap(function(){$(".nav").animate({"-webkit-transform":"translate3d(0,100%,0)","transform":"translate3d(0,100%,0)","opacity":"1"},"cubic-bezier(0.1,0.57,0.1,1)",800,function(){$(".top-bar").css("display","none")})});$(".shrink").tap(function(){$(".top-bar").css("display","block");$(".nav").animate({"-webkit-transform":"translate3d(0,0,0)","transform":"translate3d(0,0,0)","opacity":"0"},"cubic-bezier(0.1,0.57,0.1,1)",800)})});var base={ajax:function(json){$.ajax({url:"/rest",type:"POST",dataType:"json",async:json.async?json.async:false,data:{data:JSON.stringify(json.data)},success:function(data){json.success&&json.success(data)},error:function(data){json.error&&json.error(data)}})}};var photo_box=$(".photos-main"),loading=document.querySelector(".loading"),tmp_arr_pos=[];var index={now_num:0,color_arr:["#e7afc7","#747b85","#776d80","#a0a09d","#bbceef","#a9a6a4","#997a86","#d8d6d0"],b_load:true,now_height:0,photo_count:0,photo_num_arr:[],load_end:true,get_photo_count:function(){base.ajax({data:{"method":"paiwo.gallery.collection_count.get"},success:function(data){if(data.error_id==0){index.photo_count=data.response.count}else{}},error:function(data){}})},rnd_num:function(){var photo_rnd_arr=[];function rnd(n,m){return parseInt(Math.random()*(m-n))+n}function find_arr(arr,num){for(var i=0;i<arr.length;i++){if(arr[i]==num){return true}}return false}function rnd_arr(){var len=index.photo_num_arr.length;if(len==0){return}if(len<12){console.log(index.photo_num_arr);for(var i=0;i<len;i++){photo_rnd_arr.push(index.photo_num_arr[i])}index.load_end=false;index.photo_num_arr=[];$(".loading").hide()}else{while(photo_rnd_arr.length<12){len=index.photo_num_arr.length;var num=rnd(1,len+1)-1;if(!find_arr(photo_rnd_arr,index.photo_num_arr[num])){photo_rnd_arr.push(index.photo_num_arr[num]);index.photo_num_arr.splice(num,1)}}}}rnd_arr();return photo_rnd_arr},get_photo_list:function(){var rnd_num=index.rnd_num();base.ajax({data:{"method":"paiwo.gallery.collection.get","random_list":rnd_num},success:function(data){if(data.error_id==0){var list_info=data.response.photo_list.sort(function(){return(0.5-Math.random())});var list_str="";var _color=0;index.now_num++;function rnd(n,m){return parseInt(Math.random()*(m-n))+n}for(var i=0;i<list_info.length;i++){_color=rnd(1,9)-1;list_str+='<div class="photos-list" data-code="'+list_info[i].photo_id+'" style="background-color:'+index.color_arr[_color]+';"><a href="'+index.is_has_photo(list_info[i].photo_path,list_info[i].photo_id)+'" class="img-a">'+'<img height="" class="photo_img'+index.now_num+'" src="'+index.is_photo_url(list_info[i].photo_path)+'" style="opacity:0;" /></a>'+'<a href="'+index.is_has_photo(list_info[i].photo_path,list_info[i].photo_id)+'"><div class="photog_count">'+'<span class="photo_author">'+list_info[i].author_name+"</span>"+"</div>"+"</a>"+"</div>"}photo_box.append(list_str);tmp_arr_pos=[];var photo_list=document.querySelectorAll(".photo_img"+index.now_num);for(var i=0;i<photo_list.length;i++){tmp_arr_pos.push(index.get_pos(photo_list[i]).top)}}if(index.now_num==1){$(".photo_img"+1).animate({"opacity":1},600,"linear")}index.b_load=true},error:function(data){}})},get_pos:function(obj){var l=0;var t=0;while(obj){l+=obj.offsetLeft;t+=obj.offsetTop;obj=obj.offsetParent}return{left:l,top:t}},get_img_h:function(){var parent=$('<div class="photos-list"><img src="/static/phone/images/photo.jpg"><div class="photog_count"><span class="photo_author"></span></div></div>').appendTo(".photos-main");var _height=parent.find("img").get(0).scrollWidth;parent.remove();return _height},is_photo_url:function(url){var str="";if(url!=""){str="http://image.paiwo.co/"+url+"@!280x280";return str}else{str="/static/images/pic-deleted.png";return str}},is_has_photo:function(url,id){var str="";if(url!=""){str="/photos/"+id;return str}else{str="javascript:;";return str}}};(function(){index.now_height=index.get_img_h();index.get_photo_count();for(var i=1;i<=index.photo_count;i++){index.photo_num_arr.push(i)}index.get_photo_list()})();window.addEventListener("load",function(){$(".photo_img"+1).animate({"opacity":1},600,"linear")},false);window.addEventListener("scroll",function(){var photos_h=photo_box[0].scrollHeight,photos_top=photo_box[0].offsetTop,now_h=photos_h+photos_top,winH=document.documentElement.clientHeight,scrollT=document.documentElement.scrollTop||document.body.scrollTop,scrollBottom=scrollT+winH;if(scrollBottom>(now_h-100)&&index.b_load&&index.load_end){loading.style.display="block";index.b_load=false;index.get_photo_list()}for(var i=0;i<tmp_arr_pos.length;i++){if(scrollBottom>(tmp_arr_pos[i]+60)){$(".photos-list img").animate({"opacity":1},400,"linear");$(".photo_img"+index.now_num).eq(i).animate({"opacity":1},400,"linear")}}},false);window.addEventListener("resize",function(){index.now_height=index.get_img_h()},false);