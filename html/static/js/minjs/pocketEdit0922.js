function showLabel(t,e,o){checkTextStatus();var a=t+o/2-120,i=e-40;$(".text-del").css({left:a,top:i}).fadeIn(400)}function checkTextStatus(){var t=$(".pocket-text-select");$(".text-del i").removeClass("text-edit-select"),t.hasClass("text-font")?$(".font-2").addClass("text-edit-select"):$(".font-1").addClass("text-edit-select"),t.hasClass("text-center")?$(".align-center").addClass("text-edit-select"):t.hasClass("text-right")?$(".align-right").addClass("text-edit-select"):$(".align-left").addClass("text-edit-select")}function recovery(t){var e=$(t).parents(".p-blo"),o=e.find("img"),a=o[0].naturalWidth,i=o[0].naturalHeight,s=a/i,n=890/s;a>890?(o.css({width:890,height:"",left:"",top:""}),e.animate({width:890,height:n},function(){pocket.tool.updatePosition()}),e[0].box.css({width:890,height:n})):(o.css({width:"",height:"",left:"",top:""}),e.animate({width:a,height:i},function(){pocket.tool.updatePosition()}),e[0].box.css({width:a,height:i})),pocket.tool.clearAllFocus()}function showAddLabel(t,e){$(".text-add").css("top",t+e).fadeIn(400)}function showMessage(t){clearTimeout(showMessage.setM),$(".setting_succeed").html(t).animate({top:0},400,function(){showMessage.setM=setTimeout(hideMessage,1800)})}function hideMessage(){$(".setting_succeed").animate({top:-40},400)}function clearStyle(){var t=/ style="[^"]+"/gi,e=/ &lt;img&gt;[\s\S]*&lt;\/img&gt;/gi,o=this.innerHTML.replace(t,"").replace(e,"");this.innerHTML=o}function clearXss(t){var e=/&lt;script&gt;[\s\S]*&lt;\/script&gt;/g,o=/&lt;a&gt;[\s\S]*&lt;\/a&gt;/g;return String(t).replace(e,"").replace(o,"")}function getSoucer(){$.isNumeric(url_pocket)||(window.location.href="/"),$.ajax({url:"/rest",type:"POST",async:!1,data:{data:JSON.stringify({pocket_id:url_pocket,method:"paiwo.content.pocket.get"})},dataType:"json",success:function(t){0==t.error_id?(pocketData=t.response,0==pocketData.is_self?window.location.href="/":m.sendData.pocket_id=pocketData.pocket_id):window.location.href="/"}})}function mergeData(){m.sendData.cover_photo=pocketData.pocket_cover_photo,m.sendData.pocket_title=pocketData.pocket_title,m.sendData.pocket_second_title=pocketData.pocket_second_title,m.sendData.pocket_content=pocketData.pocket_content,pocketData.pocket_cover_photo="http://image.paiwo.co/"+pocketData.pocket_cover_photo}function insertData(){var t=new Image;t.className="cover-big-img",t.src=pocketData.pocket_cover_photo,t.onload=function(){$(".cover-status").css("background-image","url("+pocketData.pocket_cover_photo+")")},$(".main-title").val(pocketData.pocket_title),$(".second-title").val(pocketData.pocket_second_title);var e=$(".pocket-vir-content"),o=(e.html(pocketData.pocket_content),e.text());e.html(o),$(".pocket-content").height(e.height()),inArea()}function inArea(){var t=$();0!=$(".p-vir-blo").length&&(first=!1,$(".text-add").hide()),$(".p-vir-blo").each(function(e,o){var a,i=$(this);i.attr("src")?(a=$('<div class="p-blo" draggable="true"/>'),a.css(i.position()),a.css({width:i.width(),height:i.height()}),addimageflag(a),imageChange(a,"http://image.paiwo.co/"+i.attr("src")),a[0].box=i,t=t.add(a)):(a=$('<div contenteditable="true"/>'),a[0].className="pocket-text "+this.className,a.removeClass("p-vir-blo"),a.html(i.html()),a.css(i.position()),a.css({width:i.width()}),a[0].box=i,t=t.add(a))}),$(".pocket-content").append(t)}function addimageflag(t){var e='<div class="p-img-wrap"></div><i class="p-r"></i><i class="p-b"></i><i class="p-rb"></i><span class="add-flag"><span class="a-flag">添加..</span><i class="b-img"></i><i class="b-text"></i></span><div class="del-flag"><i class="del-flag-one"></i><i class="del-flag-two">还原</i></div>';t.html(e)}function imageChange(t,e){var o=new Image;o.className="p-img",o.draggable="false";var a=t.width(),i=t.height();o.onload=function(){var e=a/i,s=o.naturalWidth/o.naturalHeight;if(e>s){var n=a/s;o.style.height=n+"px",o.style.width=a+"px";var c=-(n-i)/2;$(o).css({left:0,top:c})}else{var l=s*i;o.style.width=l+"px",o.style.height=i+"px";var p=-(l-a)/2;$(o).css({left:p,top:0})}t.find(".p-img-wrap").html(o)},o.src=e}var myts,pocket={};pocket.tool={},pocket.bindNode=function(){this.main=$(".pocket-content"),this.vmain=$(".pocket-vir-content"),this.files=$("#pocketFiels"),this.t={}},pocket.alterView=function(){$(".pocket-vir-content").css({top:-5e4,left:-2e3}),$(".pocket-content").on("selectstart",function(t){t.preventDefault()})},pocket.bindEvent=function(){var t=this.main,e=(this.vamin,this.t);myts=e,$("#addImg").on("click",function(){myindex=0,$("#pocketFiels").trigger("click")}),$("#hidediv").on("change","#pocketFiels",function(){first&&$(".text-add").hide();for(var t=0;t<this.files.length;t++)pocket.tool.checkFile(this.files[t])&&pocket.tool.addFile(this.files[t],myindex);$("#hidediv").prepend('<input type="file" multiple id="pocketFiels" accept="image/jpg,image/png,image/jpeg">'),$(this).remove()}),$("#addText").on("click",function(t){myindex=0,pocket.tool.addText(myindex)}),t.on("click",".a-flag",function(t){t.stopPropagation()}),t.on("click",".pocket-text",function(t){var e=$(this);e.hasClass("pocket-text-select")||(pocket.tool.clearAllFocus(),e.addClass("pocket-text-select"),showLabel(e.position().left,e.position().top,e.width()),showAddLabel(e.position().top,e.height())),t.stopPropagation()}),t.on("selectstart",".pocket-text",function(t){t.stopPropagation()}),t.on("click",".p-r",function(t){t.stopPropagation()}),t.on("click",".p-b",function(t){t.stopPropagation()}),t.on("click",".p-rb",function(t){t.stopPropagation()}),t.on("input",".pocket-text",function(){this.scrollHeight!=this.sc&&(this.sc=this.scrollHeight,this.box.height(this.sc),pocket.tool.updatePosition())}),t.on("paste",".pocket-text",function(){setTimeout(clearStyle.bind(this),300)}),t.on("mousedown",".p-r",function(t){e.flag=!0,e.type="width",e.target=$(this),e.target_box=e.target.parent(),e.w=e.target_box.width(),e.h=e.target_box.height(),e.ol=e.target_box.offset().left,e.ot=e.target_box.offset().top,e.target_img=e.target_box.find("img"),e.target_box.attr("draggable","false"),e.r=e.target_box.find(".p-r"),e.b=e.target_box.find(".p-b").hide(),e.rb=e.target_box.find(".p-rb").hide(),e.target_box.find(".add-flag").hide(),e.target_box.find(".del-flag").hide(),t.stopPropagation()}),t.on("mousedown",".p-b",function(t){e.flag=!0,e.type="height",e.target=$(this),e.target_box=e.target.parent(),e.w=e.target_box.width(),e.h=e.target_box.height(),e.ol=e.target_box.offset().left,e.ot=e.target_box.offset().top,e.target_img=e.target_box.find("img"),e.target_box.attr("draggable","false"),e.b=e.target_box.find(".p-b"),e.r=e.target_box.find(".p-r").hide(),e.rb=e.target_box.find(".p-rb").hide(),e.target_box.find(".add-flag").hide(),e.target_box.find(".del-flag").hide(),t.stopPropagation()}),t.on("mousedown",".p-rb",function(t){e.flag=!0,e.type="rb",e.target=$(this),e.target_box=e.target.parent(),e.w=e.target_box.width(),e.h=e.target_box.height(),e.ol=e.target_box.offset().left,e.ot=e.target_box.offset().top,e.target_img=e.target_box.find("img"),e.target_box.attr("draggable","false"),e.b=e.target_box.find(".p-b").hide(),e.r=e.target_box.find(".p-r").hide(),e.rb=e.target_box.find(".p-rb"),e.target_box.find(".add-flag").hide(),e.target_box.find(".del-flag").hide(),t.stopPropagation()}),$(document).on("mousemove",function(t){if(e.flag)if("width"==e.type){var o=e.target_box.width();if(o>900||280>o)return!1;var a=t.pageX-e.ol-10;e.target.css({left:a-5}),e.target_box.width(a)}else if("height"==e.type){var i=e.target_box.height();if(i>1440||280>i)return!1;var s=t.pageY-e.ot-5;e.target.css({top:s}),e.target_box.height(s)}else{var i=e.target_box.height(),o=e.target_box.width();if(1450>i&&i>280){var s=t.pageY-e.ot-5;e.target.css({top:s}),e.target_box.height(s)}if(901>o&&o>280){var a=t.pageX-e.ol-10;e.target.css({left:a-5}),e.target_box.width(a)}}}),$(document).on("mouseup",function(t){e.flag&&(e.target_box.attr("draggable","true"),e.flag=!1,"width"==e.type?pocket.tool.changeSize(e.type,e.target_box.width()):"height"==e.type?pocket.tool.changeSize(e.type,e.target_box.height()):pocket.tool.changeSize(e.type,e.target_box.width(),e.target_box.height()))}),t.on("dragstart",".p-blo",function(t){t.originalEvent.dataTransfer.setData("movename",this.box.index())}),t.on("dragover",".p-blo",function(t){t.preventDefault()}),t.on("dragenter",".p-blo",function(t){t.preventDefault()}),t.on("drop",".p-blo",function(t){var e=t.originalEvent.dataTransfer.getData("movename"),o=this.box.index();e!=o&&(pocket.tool.swap(e,o),pocket.tool.updatePosition())}),t.on("click",".p-blo",function(t){var e=$(this);e.hasClass("select")?pocket.tool.clearAllFocus():(pocket.tool.clearAllFocus(),e.addClass("select"),pocket.t.target_box=$(this),pocket.tool.upBorder(),e.find(".p-r,.p-b,.p-rb").fadeIn(400)),t.stopPropagation()}),t.on("click",".b-img",function(t){myindex=$(this).parents(".p-blo")[0].box.index()+1,$("#pocketFiels").trigger("click"),t.stopPropagation()}),t.on("click",".b-text",function(t){myindex=$(this).parents(".p-blo")[0].box.index()+1,pocket.tool.addText(myindex),t.stopPropagation()}),t.on("click",".a-text",function(t){myindex=first?0:$(".pocket-text-select")[0].box.index()+1,pocket.tool.addText(myindex),t.stopPropagation()}),t.on("click",".a-img",function(t){myindex=first?0:$(".pocket-text-select")[0].box.index()+1,$("#pocketFiels").trigger("click"),t.stopPropagation()}),t.on("click",".font-1,.font-2",function(t){var e=$(this);if(!e.hasClass("edit-select")){var o=$(".pocket-text-select");e.hasClass("font-1")?($(".font-1").addClass("text-edit-select"),$(".font-2").removeClass("text-edit-select"),o.removeClass("text-font")):($(".font-2").addClass("text-edit-select"),$(".font-1").removeClass("text-edit-select"),o.addClass("text-font")),t.stopPropagation()}}),t.on("click",".align-left,.align-center,.align-right",function(t){var e=$(this);if(!e.hasClass("edit-select")){var o=$(".pocket-text-select");$(".a-edit-align i").removeClass("text-edit-select"),e.addClass("text-edit-select"),o.removeClass("text-center"),o.removeClass("text-right"),e.hasClass("align-right")?o.addClass("text-right"):e.hasClass("align-center")&&o.addClass("text-center"),t.stopPropagation()}}),t.on("click",".a-delete",function(t){pocket.tool.deleteTarget($(".pocket-text-select")),t.stopPropagation()}),t.on("click",".del-flag-one",function(t){var e=$(this).parents(".p-blo");pocket.tool.deleteTarget(e),t.stopPropagation()}),t.on("click",".del-flag-two",function(t){recovery(this),t.stopPropagation()}),t.on("click",function(t){first||(pocket.tool.clearAllFocus(),t.stopPropagation())}),$("#ok").on("click",function(t){return 0!=m.count?void showMessage("还有照片没上传完"):""==m.sendData.cover_photo?void showMessage("请上传封面"):0==$(".main-title").val().trim().length?void showMessage("请填写主标题"):(pocket.tool.setData(),pocket.tool.release(),void(window.onbeforeunload=null))}),$("#addCov, .stuido_header_editicon").on("click",function(t){$("#cover").trigger("click")}),$("#cover").on("change",function(){if(pocket.tool.checkFile(this.files[0])){var t=this.files[0];m.count++,m.max++;var e=new FormData,o=URL.createObjectURL(t),a=new Image;a.src=o,a.onload=function(){$(".cover-status").css("background-image","url("+o+")"),$(".cover-bac").hide(),$(".cover-status").show()},$.ajax({async:!1,type:"POST",url:"/a/user/avatar/uploadurl/get",dataType:"json",success:function(o){e.append("Signature",o.response.signature),e.append("policy",o.response.policy),e.append("OSSAccessKeyId",o.response.key_id),e.append("key",o.response.object_key),e.append("success_action_status",201),e.append("file",t)}});var i=new XMLHttpRequest;i.onload=function(){m.count--;var t=$(i.response).find("Key").html();m.sendData.cover_photo=t},i.open("POST","http://paiwo.oss-cn-hangzhou.aliyuncs.com"),i.send(e),$(".pocket-content").show()}})},window.onbeforeunload=function(){return"未发布内容会被清空"},pocket.init=function(){this.alterView(),this.bindNode(),this.bindEvent()},pocket.tool.checkFile=function(t){var e=t.type.split("/"),o=e[e.length-1].toLocaleLowerCase();return"jpg"!=o&&"jpeg"!=o&&"png"!=o?!1:t.size>20146650?!1:!0},pocket.tool.addFile=function(t,e){var o=URL.createObjectURL(t),a=new Image;a.onload=function(){var i=$('<div class="p-blo"></div>'),s=$('<div class="p-img-wrap"></div>');a.k=a.width/a.height,pocket.tool.setLevel(a.width,a.height,$(a)),pocket.tool.addVblock(i,a,e);{var n=i[0].box.width(),c=i[0].box.height(),l=i[0].box.position().left;i[0].box.position().top}i.attr("draggable","true"),i.css({width:n,height:c}),a.className="p-img",a.setAttribute("draggable","false"),s.html(a),i.append(s),i.append('<i class="p-r"></i><i class="p-b"></i><i class="p-rb"></i>'),i.append('<span class="add-flag"><span class="a-flag">添加..</span><i class="b-img"></i><i class="b-text"></i></span>'),i.append('<div class="del-flag"><i class="del-flag-one"></i><i class="del-flag-two">还原</i></div>'),i.find(".p-r").css({left:n-4,top:c/2-4}),i.find(".p-b").css({left:n/2-3,top:c-4}),i.find(".p-rb").css({left:n-7,top:c-4}),i.find(".add-flag").css({left:920-l,top:c}),i.find(".del-flag").css({left:(n-80)/2,top:-52}),pocket.main.append(i),URL.revokeObjectURL(o),pocket.tool.uploadFile(t,i)},a.src=o},pocket.tool.addText=function(t){first&&(first=!1,$(".text-add").hide());var e=$('<div class="pocket-text" contenteditable="true">文本</div>');e[0].sc=30,pocket.tool.addVblock(e,t),pocket.main.append(e)},pocket.tool.addVblock=function(t,e,o){if(t.hasClass("pocket-text")){var a=$('<div class="p-vir-blo"></div>');a.css({width:880,height:30}),0==e?pocket.vmain.append(a):pocket.vmain.find(".p-vir-blo").eq(e-1).after(a)}else{var i,s,n=e.width/e.height;if(n>1){s=pocket.tool.getValue("height",e.height),i=pocket.tool.getValue("width",s*n);var c=-(s*n-i)/2;$(e).css({left:c,top:0})}else{i=pocket.tool.getValue("width",e.width),s=pocket.tool.getValue("height",i/n);var l=-(i/n-s)/2;$(e).css({left:0,top:l})}var a=$('<div class="p-vir-blo"></div>');a.css({width:i,height:s}),0==o?pocket.vmain.append(a):pocket.vmain.find(".p-vir-blo").eq(o-1).after(a)}t[0].box=a;var l=a.position().top,c=a.position().left;t.css({top:l,left:c}),pocket.tool.updatePosition(),pocket.main.height(pocket.vmain.height())},pocket.tool.swap=function(t,e){if(t>e){var o=t;t=e,e=o}if(e-t==1)return void $(".p-vir-blo").eq(t).before($(".p-vir-blo").eq(e));var a=$(".p-vir-blo").eq(t),i=$(".p-vir-blo").eq(e),s=$(".p-vir-blo").eq(e-1);a.after(i),s.after(a)},pocket.tool.updatePosition=function(){$(".p-blo,.pocket-text").each(function(){var t=this.box.position().left,e=this.box.position().top;$(this).html(),$(this).stop(!0).animate({left:t,top:e})}),pocket.main.height(pocket.vmain.height())},pocket.tool.upBorder=function(){var t=pocket.t.target_box,e=t.position().left,o=(t.position().top,t.width()),a=t.height();t.find(".p-r").css({top:a/2-5,left:o-5}).show(),t.find(".p-b").css({left:o/2-6,top:a-5}).show(),t.find(".p-rb").css({left:o-8,top:a-8}).show(),t.find(".add-flag").css({top:a+7,left:920-e}).show(),t.find(".del-flag").css({left:(o-80)/2,top:-52}).show()},pocket.tool.setLevel=function(t,e,o){var a,i,s=t/e;s>1?(i=pocket.tool.getValue("height",e),o.height(i+4)):(a=pocket.tool.getValue("width",t),o.width(a))},pocket.tool.setData=function(){$(".pocket-text").each(function(){var t=$(this);t.hasClass("text-font")&&this.box.addClass("text-font"),t.hasClass("text-center")?this.box.addClass("text-center"):t.hasClass("text-right")&&this.box.addClass("text-right"),this.box.html(clearXss(t.html()))}),m.sendData.pocket_content=$(".pocket-vir-content").html(),m.sendData.pocket_title=$(".main-title").val(),m.sendData.pocket_second_title=$(".second-title").val()},pocket.tool.uploadFile=function(t,e){m.count++,m.max++;var o=new FormData;$.ajax({async:!1,type:"POST",url:"/a/user/avatar/uploadurl/get",dataType:"json",success:function(e){o.append("Signature",e.response.signature),o.append("policy",e.response.policy),o.append("OSSAccessKeyId",e.response.key_id),o.append("key",e.response.object_key),o.append("success_action_status",201),o.append("file",t)}});var a=new XMLHttpRequest;a.onload=function(){var t=$(a.response).find("Key").html();e[0].box.attr("src",t),m.count--},a.open("POST","http://paiwo.oss-cn-hangzhou.aliyuncs.com"),a.send(o)},pocket.tool.changeSize=function(t,e,o){var a,i;"width"==t?(a=pocket.tool.getValue("width",e),pocket.t.target_box[0].box.width(a),pocket.t.r.hide(),pocket.t.b.hide(),pocket.t.target_box.animate({width:a},function(){pocket.tool.upBorder(),pocket.tool.updatePosition(),pocket.tool.changeImage(),pocket.tool.imageCenter(),myts.target_box.addClass("select")})):"height"==t?(i=pocket.tool.getValue("height",e),pocket.t.target_box[0].box.height(i),pocket.t.r.hide(),pocket.t.b.hide(),pocket.t.target_box.animate({height:i},function(){pocket.tool.upBorder(),pocket.tool.updatePosition(),pocket.tool.changeImage(),pocket.tool.imageCenter(),myts.target_box.addClass("select")})):(a=pocket.tool.getValue("width",e),i=pocket.tool.getValue("height",o),pocket.t.target_box[0].box.css({width:a,height:i}),pocket.t.target_box.animate({height:i,width:a},function(){pocket.tool.upBorder(),pocket.tool.updatePosition(),pocket.tool.changeImage(),pocket.tool.imageCenter(),myts.target_box.addClass("select")}))},pocket.tool.getValue=function(t,e){var o=290;return"width"==t?o=e>750?890:e>525?590:e>375?440:290:"height"==t&&(o=e>750?890:e>525?590:e>375?440:290),o},pocket.tool.changeImage=function(){var t=pocket.t.target_box,e=pocket.t.target_img,o=t.width(),a=t.height(),i=(e.width(),e.height(),o/a),s=e[0].naturalWidth/e[0].naturalHeight;if(i>s){var n=t.width()/s;e.height(n),e.width(t.width()),pocket.tool.imageCenter("height",a,n)}else{var c=s*t.height();e.width(c),e.height(t.height()),pocket.tool.imageCenter("width",o,c)}},pocket.tool.imageCenter=function(t,e,o){if("height"==t){var a=-(o-e)/2;pocket.t.target_img.css({left:0}),pocket.t.target_img.animate({top:a})}else{var i=-(o-e)/2;pocket.t.target_img.css({top:0}),pocket.t.target_img.animate({left:i})}},pocket.tool.clearAllFocus=function(){$(".pocket-text-select").removeClass("pocket-text-select"),$(".text-del").hide(),$(".select").removeClass("select"),$(".p-r,.p-b,.p-rb").hide(),$(".add-flag").hide(),$(".del-flag").hide(),$(".text-add").hide()},pocket.tool.deleteTarget=function(t){pocket.tool.clearAllFocus(),t[0].box.remove(),t.fadeOut(400,function(){$(this).remove(),pocket.tool.updatePosition(),m.max--,0==$(".p-vir-blo").length&&(first=!0,$(".text-add").css("top",0).show(),pocket.main.height(0))})},pocket.tool.release=function(){$.ajax({url:"/rest",type:"POST",async:!1,data:{data:JSON.stringify(m.sendData)},dataType:"json",success:function(t){0==t.error_id&&(window.location.href="/pocket/"+t.response.pocket_id)}})},pocket.tool.photoCount=function(){return m.max>36?($(".pocket-num i").html(m.max-36),!1):($(".pocket-num i").html(0),!0)};var myindex=0,m={};m.count=0,m.sendData={},m.sendData.cover_photo="",m.sendData.pocket_title="主标题",m.sendData.pocket_second_title="附标题",m.sendData.pocket_content="",m.sendData.method="paiwo.content.pocket.add",pocket.init();var first=!0;m.max=0,showMessage.setM=null;var pocketData,url_pocket=window.location.pathname.split("/")[2];m.sendData.method="paiwo.content.pocket.edit",getSoucer(),mergeData(),insertData();