function draw(e,i){if(e){var t=e.getContext("2d"),a=e.width,o=e.height;if(t.clearRect(0,0,a,o),t.font="Bold 14px Microsoft YaHei",t.fillStyle="#fff",100==i)return t.beginPath(),t.lineWidth=3,t.strokeStyle="#fafafa",t.arc(100,100,30,0*Math.PI,2*Math.PI,!1),t.fillText("100%",82,105),void t.stroke();if(0==i)return t.beginPath(),t.lineWidth=3,t.strokeStyle="#fafafa",t.fillText("0%",96,105),void t.stroke();var s=i/100*2-.5;return t.beginPath(),t.lineWidth=3,t.strokeStyle="#fafafa",t.arc(100,100,30,1.5*Math.PI,s*Math.PI,!1),t.fillText(i+"%",88,105),void t.stroke()}}function getFileUrl(e){var i=null;return void 0!=window.createObjectURL?i=window.createObjectURL(e):void 0!=window.URL?i=window.URL.createObjectURL(e):void 0!=window.webkitURL&&(i=window.webkitURL.createObjectURL(e)),i}var uploader=new plupload.Uploader({runtimes:"html5",browse_button:"select_file",container:"father_select_file",url:"http://paiwo.oss-cn-hangzhou.aliyuncs.com",drop_element: ['photobox', 'father_select_file'],flash_swf_url:"/static/js/plupload/Moxie.swf",silverlight_xap_url:"/static/js/plupload/Moxie.xap",filters:{max_file_size:"20mb",mime_types:[{title:"Image files",extensions:"jpg,jpeg,png,tiff,tif"}]},init:{PostInit:function(){$("#error_info"),$("#select_file"),$("#father_select_file")},FilesAdded:function(e,i){var t=[];plupload.each(i,function(e){var i=$("#photobox"),a=!1;0==i.children().size()&&(a=!0),t.push(e);var o='<span class="pic_shadow"></span><canvas class="canvas" width="200" height="200"></canvas><img src="" width="190" height="190" /><div style=" background:#3DB6E3; display:inline-block;height:12px; width:0%"></div>',s='<div class = "select-file" id="'+e.id+'">'+o+'<i class="select-file-i"></i><div class="photo_fixbox"><span class="set_cover span-left">设为封面</span><i></i><span class="delete_pic">删除照片</span></div></div>';i.append(s),a&&$("#"+e.id).find(".select-file-i").show();var n=document.querySelector("#"+e.id),r=n.querySelector(".canvas");draw(r,0)});for(var a=0;a<t.length;a++){var o=t[a];o.id}uploader.start()},BeforeUpload:function(){var e={},i=!1;$.ajax({async:!1,type:"POST",url:"/a/album/photo/uploadurl/get",dataType:"json",success:function(t){e=t,i=!0},error:function(i){e=i}}),1==i?uploader.setOption("multipart_params",{"Cache-Control":"max-age=25920000",policy:e.result.policy,Signature:e.result.signature,OSSAccessKeyId:e.result.key_id,key:e.result.object_key,success_action_status:201}):uploader.stop()},UploadProgress:function(e,i){$("#"+i.id).find(".canvas").remove(),pic.now_id=i.id;var t=$("#"+i.id);t.find("canvas").remove();var a='<canvas id="canvas'+i.id+'" width="200" height="200"></canvas>';t.append(a);var o=document.getElementById("canvas"+i.id);draw(o,i.percent)},FileUploaded:function(e,i,t){var a=$("#"+i.id),o=$(t.response).find("Key").text();a.find("img").removeClass("active"),a.find(".pic_shadow").remove(),a.find("canvas").remove(),a.attr("data-file",o);var s="http://image.paiwo.co/"+o+"@!280x280";a.find("img").attr("src",s),pic.type_up&&1==uploader.total.uploaded&&a.find(".select-file-i").show(),pic.count++,up_ok(pic.count),now_count.html(pic.count)},Error:function(e,i){if(-500==i.code)return void $("#error_info").show();var t=$("#"+i.file.id);-200==i.code?(showMessage(i.file.name+"上传失败"),t.find("canvas").hide(),t.find(".pic_shadow").html("上传失败")):-600==i.code&&showMessage("上传图片必须小于20M"),-601==i.code&&showMessage("上传图片只支持jpg,jpeg,png,tiff格式")}}});uploader.init();
function allow_init(){var t=store.get("allowType"),e=$(".input-allow-input");switch(t){case"01":e.html('<span><i class="input-allow_select_i6"></i></span><p>不使用原创授权</p>').attr("data","01");break;case"02":e.html('<span><i class="input-allow_select_i4"></i></span><p>版权所有，禁止转载</p>').attr("data","02");break;case"03":e.html('<span><i class="input-allow_select_i3"></i><i class="input-allow_select_i1"></i><i class="input-allow_select_i5"></i></span><p>署名-非商业使用-禁止演绎</p>').attr("data","03");break;case"04":e.html('<span><i class="input-allow_select_i3"></i><i class="input-allow_select_i1"></i><i class="input-allow_select_i2"></i></span><p>署名-非商业使用-相同方式共享</p>').attr("data","04");break;case"05":e.html('<span><i class="input-allow_select_i3"></i><i class="input-allow_select_i1"></i></span><p>署名-非商业性使用</p>').attr("data","05");break;case"06":e.html('<span><i class="input-allow_select_i3"></i><i class="input-allow_select_i5"></i></span><p>署名-禁止演绎</p>').attr("data","06");break;case"07":e.html('<span><i class="input-allow_select_i3"></i><i class="input-allow_select_i2"></i></span><p>署名-相同方式共享</p>').attr("data","07");break;case"08":e.html('<span><i class="input-allow_select_i3"></i></span><p>署名</p>').attr("data","08");break;default:e.html('<span><i class="input-allow_select_i3"></i></span><p>署名</p>').attr("data","08")}}function init_param(){file_list_num=0,init_success=!1,album_id=0,allow_status=1,delete_photo_list=[]}function refresh(t){if(init_param(),0==t.is_self)return window.location.href="/gallery",init_success=!1,!1;pic.album_id=t.album_id,file_list_num=t.photo_count,allow_status=t.cc_protocol;var e='<div class="select-file" data-code="{2}" data-file="{1}" data-o="flag"><img src="http://image.paiwo.co/{0}@!280x280"><i class="select-file-i"></i><div class="photo_fixbox"><span class="set_cover span-left">设为封面</span><i></i><span class="delete_pic">删除照片</span></div></div>',a="<span>{0}</span>",i="",l="";$.each(t.photo_list,function(t,a){i+=e.format(a.photo_path,a.photo_path,a.photo_id)}),$.each(t.tag_list,function(t,e){l+=a.format(e)}),$("#photobox").html(i),$("#tags").html(l),$("#input_title").val(t.album_name),$("#input_desc").val(t.album_desc);for(var o=$(".input-allow_select").find("li"),s=0;s<o.length;s++){var n=o.eq(s),c=n.attr("data");if(c=="0"+t.cc_protocol){$(".input-allow-input").html(n.html());break}}}function init_edit_album(){function t(t){if(0==t.error_id){pic.count=t.result.photo_count,now_count.html(pic.count),refresh(t.result),init_success=!0,0!=t.result.tag_list.length&&$("#input_tag").attr("placeholder","");var e=t.result.auto_tag,a=t.result.cover_path;if(1==e?($("#is_tag").show(),is_tag_allow=!0):($("#is_tag").hide(),is_tag_allow=!1),""!=a)for(var i=$("#photobox").children(),l=0;l<i.length;l++){var o=i[l].getAttribute("data-file");o==a&&(i[l].getElementsByClassName("select-file-i")[0].style.display="block",album_cover_path=a)}else $("#photobox").children()[0].getElementsByClassName("select-file-i")[0].style.display="block",album_cover_path=$("#photobox").children()[0].getAttribute("data-file")}else init_success=!1,slideMessage("获取相册图片列表失败"+t.error_code)}function e(){init_success=!1,slideMessage("网络错误")}var a=window.location.hash.split("/")[1];a?$.ajax({async:!1,type:"POST",url:"/a/album/photo/list",dataType:"json",data:{is_edit:1,album_id:a},success:t,error:e}):(slideMessage("非法相册"),init_success=!1)}function keyevent(t){var e=document.activeElement.id;if(8==t.keyCode&&"input_tag"==e){if(0!=$("#input_tag").val().length)return!0;$("#tags span:last-child").remove(),0==$("#tags").children().length&&$("#input_tag").attr("placeholder","在此直接输入标签，使用空格或回车分隔")}if((32==t.keyCode||13==t.keyCode||186==t.keyCode||188==t.keyCode)&&"input_tag"==e){var a=$("#input_tag");if(a.val().length>0){var i=getStrLen(a.val());if($("#input_tag").attr("placeholder",""),24>=i){var l=a.val().replace(/ /g,"");$("#tags").append("<span>"+l+"</span>\n");var a=$("#input_tag");return a.focus(),a.val(""),!1}return slideMessage("不得超过24个字符"),!1}return a.val(""),!1}}function common_tag_click(){$("#tags").append("<span>"+$(this).html()+"</span>\n");var t=$("#tags").children();console.log(t),0==t?$("#input_tag").attr("placeholder","在此直接输入标签，使用空格或回车分隔"):$("#input_tag").attr("placeholder","")}function input_tag_click(){var t=$("#input_tag"),e=t.val(),a=new RegExp(" ","g");e=e.replace(a,""),""==e?t.val(""):($("#input_tag_list").append("<span>"+e+"</span>\n"),t.val(""))}function delete_tag_click(){$(this).remove(),$(this).next().remove()}function getStrLen(t){for(var e=0,a=/[\u4e00-\u9fa5]/,i=0;i<t.length;i++){if(a.test(t.charAt(i))){e+=2;break}e++}return e}function up_ok(t){36>=t?now_count.css("color","#b6b3aa"):now_count.css("color","#ff475c")}function showMessage(t){slideMessage(t)}function slideMessage(t){clearTimeout(setM),mes.html(t).animate({top:0},400,function(){setM=setTimeout(hideMessage,1800)})}function hideMessage(){mes.animate({top:"-40px"},400)}var pic={count:0,delete_photo_list:[],album_id:0,type_up:!1,type_edit:!0},now_count=$("#now_count");String.prototype.format||(String.prototype.format=function(){var t=arguments;return this.replace(/{(\d+)}/g,function(e,a){return"undefined"!=typeof t[a]?t[a]:e})}),allow_init();var file_list_num=0,init_success=!1,album_id=0,allow_status=1,delete_photo_list=[];$("#common_tag").on("click","span",common_tag_click),$("#input_tag_on").on("click",input_tag_click),$("#tags").on("click","span",delete_tag_click),document.onkeydown=keyevent;var sel_allow_box=$("#allow_select_box"),b_sel_allow_box=!1,triangle=$(".input-allow .select-arrow"),allow_btn=$(".input-allow-input");allow_btn.on("click",function(t){b_sel_allow_box?(sel_allow_box.stop().animate({opacity:0,height:0},300,"linear"),b_sel_allow_box=!1,triangle.removeClass("select-arrow-active")):(sel_allow_box.stop().animate({opacity:1,height:362},300,"linear"),b_sel_allow_box=!0,triangle.addClass("select-arrow-active")),t.stopPropagation()}),sel_allow_box.on("click","li",function(){var t=$(this).html(),e=$(this).attr("data");allow_btn.html(t).attr("data",e),store.set("allowType",e)}),$("#photobox").on("mouseenter",".select-file",function(){$(this).find(".photo_fixbox").stop().animate({bottom:"5px"},100)}),$("#photobox").on("mouseleave",".select-file",function(){$(this).find(".photo_fixbox").stop().animate({bottom:"-30px"},100)});var photo_box=$("#photobox"),album_cover_path="";photo_box.on("click",".set_cover",function(){photo_box.find(".select-file-i").hide(),$(this).parents(".select-file").find(".select-file-i").stop().fadeIn(100),album_cover_path=$(this).parents(".select-file").attr("data-file")}),photo_box.on("click",".delete_pic",function(){var t=$(this).parents(".select-file").find(".select-file-i").css("display");flag="block"==t||"inline"==t?!0:!1,pic.now_id&&uploader.removeFile(pic.now_id);var e=$(this).parents(".select-file");e.attr("data-file")?("flag"==e.attr("data-o")&&pic.delete_photo_list.push(e.attr("data-code")),pic.count--,up_ok(pic.count),now_count.html(pic.count)):uploader.removeFile(pic.now_id),e.remove(),flag&&0!=$("#photobox").children()&&($("#photobox").children().eq(0).find(".select-file-i").show(),album_cover_path=$("#photobox").children().eq(0).attr("data-file"))});var is_tag_allow=!0;$(".checkbox").on("click",function(){var t=$(this).find("i");return is_tag_allow?(t.hide(),is_tag_allow=!1):(t.show(),is_tag_allow=!0),!1}),$("#main_box").on("click",function(t){sel_allow_box.stop().animate({opacity:0,height:0},300,"linear"),b_sel_allow_box=!1,triangle.removeClass("select-arrow-active"),t.stopPropagation()}),$("#edit_submit").on("click",function(){var t={};t.new_photo_list=[],t.old_photo_list=[],t.tag_list=[];var e={count:pic.count,b_up:!1,b_count:!1,b_tag:!1,b_tit:!1,b_desc:!1},a=uploader.total.queued;if(a>0)return slideMessage("图片正在上传中..."),void(e.b_up=!1);0==a&&(e.b_up=!0);var i=$("#photobox").children().length;if(now_count.html(i),!(36>=i&&i>0))return 0==i?(slideMessage("请添加照片"),void(e.b_count=!1)):(slideMessage("专辑内图片数量不得超过36张"),void(e.b_count=!1));e.b_count=!0;var l=($("#is_tag").css("display"),$("#tags").children().length);if(is_tag_allow){for(var o=$("#tags").children(),s=0;s<o.length;s++)t.tag_list.push(o[s].innerHTML);t.auto_tag=1,e.b_tag=!0}else if(0==is_tag_allow&&l>0){for(var o=$("#tags").children(),s=0;s<o.length;s++)t.tag_list.push(o[s].innerHTML);t.auto_tag=0,e.b_tag=!0}else if(0==is_tag_allow)return e.b_tag=!1,void slideMessage("请填写标签");var n=$("#input_title").val();if(""==n)return slideMessage("标题不能为空"),void(e.b_tit=!1);var c=getStrLen(n);if(!(30>=c))return slideMessage("标题不能超过30个字"),void(e.b_tit=!1);if(e.b_tit=!0,e.b_up&&e.b_count&&e.b_tag&&e.b_tit){var _=$("#photobox").children();t.cover_path="";for(var s=0;s<_.length;s++){var r=_[s].getAttribute("data-o");if(_[s].getElementsByClassName("select-file-i")[0],r){var p=_[s].getAttribute("data-code");t.old_photo_list.push(p)}else{var u=_[s].getAttribute("data-file");if(!u)return void slideMessage("有图片上传失败");var d={};d.photo_path=u,t.new_photo_list.push(d)}}t.delete_photo_list=pic.delete_photo_list,t.album_id=pic.album_id,t.album_name=n,t.album_desc=$("#input_desc").val(),t.cc_protocol=$(".input-allow-input").attr("data"),t.cover_path=album_cover_path,$.ajax({async:!1,type:"POST",url:"/a/album/edit",dataType:"json",data:{body:JSON.stringify(t)},success:function(t){0==t.error_id?window.location.href="/"+t.result.user_host+"#/album/"+t.result.album_id:slideMessage("上传错误")},error:function(){slideMessage("网络错误")}})}}),$("#edit_cancel").on("click",function(){var t=$(".tab-icon_mybrowse").attr("href");window.location.href=t?t:"/gallery"}),window.onhashchange=init_edit_album,init_edit_album();var mes=$(".setting_succeed"),setM=null;$(".qusetion-hover").mouseenter(function(){$(".list-qusetion-hover").show()}),$(".qusetion-hover").mouseleave(function(){$(".list-qusetion-hover").hide()});var tagSpan=0;$(".tags-type span").click(function(){var t=$(".tags-type span").index($(this));if(tagSpan!=t){tagSpan=t,$(".tags-rela div").fadeOut(100);for(var e=0;e<$(".tags-rela").length;e++)$(".tags-rela").eq(e).find("div").eq(t).fadeIn(100)}});